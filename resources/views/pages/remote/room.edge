@layout('layouts/app')
@set('title', 'Remote')
@set('subTitle', building.name)
@set('subSubTitle', room.name)

@section('content')
<div class="row gx-5 g-md-10 g-xl-10 px-lg-20">
  @each((item) in data)
  <div class="col-lg-6">
    <div class="loadDataButton card card-flush bgi-no-repeat bgi-size-contain bgi-position-x-end h-xl-100" data-url="{{ item.id }}">
      <div class="card-body rounded-2 bg-secondary text-gray-900 border border-gray-900 p-5 d-flex justify-content-between align-items-end" style="solid rgba(255, 255, 255, 0.3);background: rgba(0, 0, 0, 0.15);">
        <div class="d-flex align-items-center">
          <div class="symbol symbol-50px w-50px bg-white p-3 d-flex justify-content-center me-5 text-gray-500">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-fan" viewBox="0 0 16 16">
              <path d="M10 3c0 1.313-.304 2.508-.8 3.4a2 2 0 0 0-1.484-.38c-.28-.982-.91-2.04-1.838-2.969a8 8 0 0 0-.491-.454A6 6 0 0 1 8 2c.691 0 1.355.117 1.973.332Q10 2.661 10 3m0 5q0 .11-.012.217c1.018-.019 2.2-.353 3.331-1.006a8 8 0 0 0 .57-.361 6 6 0 0 0-2.53-3.823 9 9 0 0 1-.145.64c-.34 1.269-.944 2.346-1.656 3.079.277.343.442.78.442 1.254m-.137.728a2 2 0 0 1-1.07 1.109c.525.87 1.405 1.725 2.535 2.377q.3.174.605.317a6 6 0 0 0 2.053-4.111q-.311.11-.641.199c-1.264.339-2.493.356-3.482.11ZM8 10c-.45 0-.866-.149-1.2-.4-.494.89-.796 2.082-.796 3.391q0 .346.027.678A6 6 0 0 0 8 14c.94 0 1.83-.216 2.623-.602a8 8 0 0 1-.497-.458c-.925-.926-1.555-1.981-1.836-2.96Q8.149 10 8 10M6 8q0-.12.014-.239c-1.02.017-2.205.351-3.34 1.007a8 8 0 0 0-.568.359 6 6 0 0 0 2.525 3.839 8 8 0 0 1 .148-.653c.34-1.267.94-2.342 1.65-3.075A2 2 0 0 1 6 8m-3.347-.632c1.267-.34 2.498-.355 3.488-.107.196-.494.583-.89 1.07-1.1-.524-.874-1.406-1.733-2.541-2.388a8 8 0 0 0-.594-.312 6 6 0 0 0-2.06 4.106q.309-.11.637-.199M8 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
            </svg>
          </div>
          <div class="fw-bold">
            <span class="fs-2 d-block">{{ item.code }}</span>
            <span class="opacity-50">{{ item.device.merk }}</span>
          </div>
        </div>
        <div id="{{ item.id }}">
        </div>
      </div>
    </div>
  </div>
  @endeach
</div>

<div id="kt_drawer_chat" class="bg-body" data-kt-drawer="true" data-kt-drawer-name="chat" data-kt-drawer-activate="true" data-kt-drawer-overlay="true" data-kt-drawer-width="{default:'300px', 'md': '500px'}" data-kt-drawer-direction="end" data-kt-drawer-toggle=".loadDataButton" data-kt-drawer-close="#kt_drawer_chat_close">
  <div class="card w-100 border-0 rounded-0" id="kt_drawer_chat_messenger">
    <div class="card-header pe-5" id="header">
      <div class="card-title title">
        <div class="d-flex justify-content-center flex-column me-3">
          <div class="d-flex align-items-center">
            <span class="badge badge-success badge-circle w-10px h-10px me-2"></span>
            <span class="fs-4 fw-bold text-gray-900 lh-1 code">-</span>
          </div>
          <div class="mb-0 lh-1">
            <span class="fs-7 fw-semibold text-muted device">-</span>
          </div>
        </div>
      </div>
      <div class="card-toolbar">
        <div class="btn btn-sm btn-icon btn-active-color-primary" id="kt_drawer_chat_close">
          <i class="ki-outline ki-cross-square fs-2"></i>
        </div>
      </div>
    </div>
    <div class="card-body" id="kt_drawer_chat_messenger_body">
      <div class="scroll-y me-n5 pe-5" data-kt-element="messages" data-kt-scroll="true" data-kt-scroll-activate="true" data-kt-scroll-height="auto" data-kt-scroll-dependencies="#kt_drawer_chat_messenger_header, #kt_drawer_chat_messenger_footer" data-kt-scroll-wrappers="#kt_drawer_chat_messenger_body" data-kt-scroll-offset="0px">
        <ul class="nav nav-tabs nav-line-tabs mb-5 fs-6">
          <li class="nav-item">
              <a class="nav-link active fw-bold" data-bs-toggle="tab" id="remote" href="#kt_tab_pane_1">Remote</a>
          </li>
          <li class="nav-item">
              <a class="nav-link fw-bold" data-bs-toggle="tab" id="log" href="#kt_tab_pane_2">Log</a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-bold" data-bs-toggle="tab" id="share" href="#kt_tab_pane_3">Share</a>
          </li>
        </ul>
      
        <div class="tab-content" id="myTabContent">
          <div class="tab-pane fade show active" id="kt_tab_pane_1" role="tabpanel">
            <div class="row pt-5">
              <div class="col-7 d-flex align-items-stretch" id="item">
                <div class="card flex-fill bg-info">
                  <div class="card-body">
                    <h1 class="fs-3 fw-bold text-white lh-1 code">-</h1>
                    <span class="fs-7 fw-semibold text-white device">-</span>
                    <div class="text-end d-flex align-items-end justify-content-end align-content-end turn">
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-5 d-flex align-items-stretch hover-elevate-up">
                <button class="p-0 m-0 border-0 w-100 bg-transparent" id="swing">
                  <div class="card flex-fill bg-dark">
                    <div class="card-body text-end">
                      <span class="fs-7 fw-semibold text-white">Swing Mode</span>
                      <div class="text-end mt-8">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-fan text-white mt-5 mt-md-0" viewBox="0 0 16 16">
                          <path d="M10 3c0 1.313-.304 2.508-.8 3.4a2 2 0 0 0-1.484-.38c-.28-.982-.91-2.04-1.838-2.969a8 8 0 0 0-.491-.454A6 6 0 0 1 8 2c.691 0 1.355.117 1.973.332Q10 2.661 10 3m0 5q0 .11-.012.217c1.018-.019 2.2-.353 3.331-1.006a8 8 0 0 0 .57-.361 6 6 0 0 0-2.53-3.823 9 9 0 0 1-.145.64c-.34 1.269-.944 2.346-1.656 3.079.277.343.442.78.442 1.254m-.137.728a2 2 0 0 1-1.07 1.109c.525.87 1.405 1.725 2.535 2.377q.3.174.605.317a6 6 0 0 0 2.053-4.111q-.311.11-.641.199c-1.264.339-2.493.356-3.482.11ZM8 10c-.45 0-.866-.149-1.2-.4-.494.89-.796 2.082-.796 3.391q0 .346.027.678A6 6 0 0 0 8 14c.94 0 1.83-.216 2.623-.602a8 8 0 0 1-.497-.458c-.925-.926-1.555-1.981-1.836-2.96Q8.149 10 8 10M6 8q0-.12.014-.239c-1.02.017-2.205.351-3.34 1.007a8 8 0 0 0-.568.359 6 6 0 0 0 2.525 3.839 8 8 0 0 1 .148-.653c.34-1.267.94-2.342 1.65-3.075A2 2 0 0 1 6 8m-3.347-.632c1.267-.34 2.498-.355 3.488-.107.196-.494.583-.89 1.07-1.1-.524-.874-1.406-1.733-2.541-2.388a8 8 0 0 0-.594-.312 6 6 0 0 0-2.06 4.106q.309-.11.637-.199M8 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2"/>
                          <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        </svg>
                      </div>
                    </div>
                  </div>
                </button>
              </div>
            </div>   
            <div class="row mt-5">
              <div class="col-12 d-flex align-items-stretch" id="display">
                <div class="card flex-fill" style="background-color: #a2ff00">
                  <div class="card-body d-flex justify-content-between align-content-center">
                    <div>
                      <span class="fs-7 fw-semibold text-black">Temperature</span>
                      <h1 class="fs-4hx fw-extrabold text-dark lh-1 mt-5 temperature">-</h1>
                    </div>
                    <div class="py-2">
                      <div class="me-2 mb-5">
                        <button class="btn btn-icon bg-danger rounded-circle hover-scale" id="up">
                          <i class="ki-outline ki-black-up fs-1 text-white"></i>
                        </button>
                      </div>
                      <div class="me-2">
                        <button class="btn btn-icon bg-primary rounded-circle hover-scale" id="down">
                          <i class="ki-outline ki-black-down fs-1 text-white"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>     
            <div class="row mt-5">
              <div class="col-12 d-flex align-items-stretch" id="schedule">
                <div class="card flex-fill" style="background-color: #fff700;">
                  <div class="card-body p-5 d-flex justify-content-between">
                    <div>
                      <input type="time" class="form-control form-control-lg bg-transparent border-0 fs-1 fw-bold" id="time">
                      <label for="" class="ms-5 fw-semibold text-black">Time Schedule</label>
                    </div>
                    <div>
                      <button class="btn btn-light-warning btn-icon btn-sm bg-white" id="reset">
                        <i class="ki-duotone ki-arrows-loop fs-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        </i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="kt_tab_pane_2" role="tabpanel">
              <!-- Tabel Container -->
              <div id="table-container" class=" pt-5">
                <table id="logTable" class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
                <nav aria-label="Page navigation">
                    <ul id="pagination" class="pagination justify-content-end">
                    </ul>
                </nav>
              </div>
          </div>
          <div class="tab-pane fade" id="kt_tab_pane_3" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center pt-5">
              <div>
                <h5 class="mb-0 pb-0">Share</h5>
                <span class="text-muted">Share a remote as public</span>
              </div>
              <div class="form-check form-switch form-check-custom form-check-dark form-check-solid">
                <input class="form-check-input" id="shareToggle" type="checkbox" value="" />
              </div>
            </div>
            <div class="mt-5">
              <div class="input-group mb-5">
                <input type="text" class="form-control form-control-solid" value=""/>
                <button class="btn btn-dark btn-icon"><i class="ki-outline ki-copy fs-3"></i></button>
                <button class="btn btn-danger btn-icon"><i class="ki-outline ki-arrows-loop fs-3"></i></button>
              </div>
            </div>
          </div>
        </div> 
      </div>
    </div>
  </div>
</div>

<div class="position-fixed bottom-0 end-0 mt-5 me-5" style="z-index: 9999;">
  <div class="toast align-items-center bg-danger" id="error" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex px-5 py-4">
      <div class="toast-body text-white fs-6">
      </div>
      <button type="button" class="btn-close me-2 m-auto bg-white p-2" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  @each((item) in data)
    $(document).ready(function() {
        function updateData() {
            var url = "/remote/{{building.id}}/{{room.id}}/{{item.id}}";

            $.ajax({
                url: url,
                method: 'GET',
                success: function(response) {
                  var statusBadge = response.data.is_active 
                              ? '<span class="badge badge-light-success"><span class="badge badge-success badge-circle w-10px h-10px me-2"></span> Active</span>'
                              : '<span class="badge badge-light-danger"><span class="badge badge-danger badge-circle w-10px h-10px me-2"></span> Inactive</span>';

                    $('#{{item.id}}').html(statusBadge)
                },
                error: function(xhr) {
                    console.error('Error fetching data:', xhr);
                }
            });
        }
        setInterval(updateData, 2000);
        updateData();
    });
  @endeach
</script>

<script>
  $(document).ready(function() {
      function loadData(url) {
          var buildingId = "{{building.id}}";
          var roomId = "{{room.id}}";
          var baseurl = '/remote/' + buildingId + '/' + roomId + '/' + url;
          fetchData(baseurl, 1);
          
          $.ajax({
              url: baseurl,
              method: 'GET',
              success: function(response) {
                  const data = response.data;
                  $('#header .title .code').text(data.code);
                  $('#header .title .device').text(data.device.merk);
                  $('#item .code').text(data.code);
                  $('#item .device').first().text(data.device.merk);
                  
                  // Mengatur status tombol On/Off
                  if(data.is_active){
                      $('#item .turn').html(`
                          <button class="btn btn-icon bg-white rounded-circle hover-scale text-danger mt-7 mt-md-0" id="off">
                              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-power" viewBox="0 0 16 16">
                                  <path d="M7.5 1v7h1V1z"/>
                                  <path d="M3 8.812a5 5 0 0 1 2.578-4.375l-.485-.874A6 6 0 1 0 11 3.616l-.501.865A5 5 0 1 1 3 8.812"/>
                              </svg>
                          </button>
                      `);
                      $('#display .temperature').html(data.temperature + ' &deg;C');
                  } else {
                      $('#item .turn').html(`
                          <button class="btn btn-icon bg-white rounded-circle hover-scale text-success mt-7 mt-md-0" id="on">
                              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-power" viewBox="0 0 16 16">
                                  <path d="M7.5 1v7h1V1z"/>
                                  <path d="M3 8.812a5 5 0 0 1 2.578-4.375l-.485-.874A6 6 0 1 0 11 3.616l-.501.865A5 5 0 1 1 3 8.812"/>
                              </svg>
                          </button>
                      `);
                      $('#display .temperature').html('-');
                  }
                  
                  // Mengatur input jadwal waktu
                  if (data.schedule) {
                      $('#schedule input[type="time"]').val(data.schedule);
                  } else {
                      $('#schedule input[type="time"]').val('');
                  }

                  // Mengatur status checkbox Share
                  $('#shareToggle').prop('checked', data.is_publish || false);

                  // Event handler untuk tombol On
                  $('#on').off('click').on('click', function() {
                      const onURL = baseurl + '/on';
                      $.ajax({
                          url: onURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk tombol Off
                  $('#off').off('click').on('click', function() {
                      const offURL = baseurl + '/off';
                      $.ajax({
                          url: offURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk tombol Swing
                  $('#swing').off('click').on('click', function() {
                      const swingURL = baseurl + '/swing';
                      $.ajax({
                          url: swingURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk tombol Up
                  $('#up').off('click').on('click', function() {
                      const upURL = baseurl + '/up';
                      $.ajax({
                          url: upURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk tombol Down
                  $('#down').off('click').on('click', function() {
                      const downURL = baseurl + '/down';
                      $.ajax({
                          url: downURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk tombol Reset
                  $('#reset').off('click').on('click', function() {
                      const resetURL = baseurl + '/time-reset';
                      $.ajax({
                          url: resetURL,
                          method: 'POST',
                          success: function(response) {
                              loadData(url);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk input waktu
                  $('#time').off('change').on('change', function() {
                      const setTimeURL = baseurl + '/time-set';
                      const timeValue = $(this).val();
                      $.ajax({
                          url: setTimeURL,
                          method: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify({ time: timeValue }),
                          success: function(response) {
                              $('#schedule input[type="time"]').val(timeValue);
                          },
                          error: function(xhr) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                          }
                      });
                  });

                  // Event handler untuk toggle Share
                  $('#shareToggle').off('change').on('change', function() {
                      var isChecked = $(this).is(':checked');
                      var shareURL = baseurl + '/share';

                      var data = {
                          switch: isChecked
                      };

                      $.ajax({
                          url: shareURL,
                          type: 'POST',
                          contentType: 'application/json',
                          data: JSON.stringify(data),
                          success: function(response) {
                              showToast('Status share berhasil diperbarui.');
                          },
                          error: function(xhr, status, error) {
                              showToast(`${xhr.responseJSON.message || 'an error occured'}`);
                              $('#shareToggle').prop('checked', !isChecked);
                          }
                      });
                  });
              },
              error: function(xhr) {
                  showToast(`an error occured`);
              }
          });
          
          $('#remote').off('click').on('click', function() {
              loadData(url);
          });
      }

      // Fungsi untuk mengambil data log dan menangani pagination
      let currentPage = 1;
      const rowsPerPage = 10;
      function fetchData(baseurl, page) {
          const logURL = `${baseurl}/log?page=${page}`;
          $.ajax({
              url: logURL,
              method: 'GET',
              success: function(response) {
                  if (response.success) {
                      const data = response.data.data;
                      const meta = response.data.meta;
                      const totalPages = meta.last_page;

                      const tableBody = $('#logTable tbody');
                      tableBody.empty();
                      data.forEach(item => {
                          tableBody.append(`
                              <tr>
                                  <td>${item.is_active ? 'Active' : 'Inactive'}</td>
                                  <td>${new Date(item.created_at).toLocaleString()}</td>
                              </tr>
                          `);
                      });

                      const pagination = $('#pagination');
                      pagination.empty();
                      
                      if (meta.current_page > 1) {
                          pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${meta.current_page - 1}" data-url="${baseurl}">Previous</a></li>`);
                      }
                      
                      for (let i = 1; i <= totalPages; i++) {
                          pagination.append(`<li class="page-item ${i === meta.current_page ? 'active' : ''}"><a class="page-link" href="#" data-url="${baseurl}" data-page="${i}">${i}</a></li>`);
                      }
                      
                      if (meta.current_page < totalPages) {
                          pagination.append(`<li class="page-item"><a class="page-link" href="#" data-page="${meta.current_page + 1}" data-url="${baseurl}">Next</a></li>`);
                      }
                  } else {
                      showToast('Error: Failed to load data');
                  }
              },
              error: function(xhr) {
                  showToast(`Failed to load data`);
              }
          });
      }

      // Event handler untuk pagination
      $(document).on('click', '#pagination .page-link', function(e) {
          e.preventDefault();
          const page = $(this).data('page');
          const url  = $(this).data('url');
          if (page && page !== currentPage) {
              currentPage = page;
              fetchData(url, currentPage);
          }
      });
  
      // Event handler untuk tombol loadDataButton
      $('.loadDataButton').on('click', function() {
          var url = $(this).data('url');
          loadData(url);
      });

      // Fungsi untuk menampilkan toast notifikasi
      function showToast(message) {
          $('.toast-body').text(message);
          $('.toast').toast('show');
      }
  });
  </script>


@endsection
